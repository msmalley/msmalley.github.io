<!DOCTYPE html>
<html>
    
    <head>
        
        <!-- META -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <link rel='dns-prefetch' href='//s.w.org' />
        <title>CORTEX JS</title>
        
        <!-- STYLES -->
        <link rel="stylesheet" href="css/mvp.css">
        <link rel="stylesheet" href="css/cortex.css">
        
    </head>
    <body data-mustache="cortex.config.sdk" data-loading="true" data-position="fixed" id="cortex-clipboard">
        
        <a href="#" class="create_passkey">CREATE v0.0.15</a> 
        <hr>
        <a href="#" class="get_passkey">GET</a> 
        
    </body>
    
    <script src="../js/buffer.js"></script>
    
    <script>
    var user_id = 'mark.smalley.my';
    //var domainId = 'smalley.my';
    var domainId = 'localhost';
        
    var firstSalt = new Uint8Array(new Array(32).fill(1)).buffer;
        
    var create_buttons = document.querySelectorAll('.create_passkey');
    var get_buttons = document.querySelectorAll('.get_passkey');

    create_buttons.forEach(function(button, i)
    {
        button.addEventListener("click", async function(e)
        {
            e.preventDefault();
            
            var publicKeyCredentialCreationOptions = 
            {
                challenge: Buffer.from('the-challenge', 'utf8'),
                rp: {
                    id: domainId,
                    name: "Test"
                },
                user: {
                    id: Buffer.from(user_id, 'utf8'),
                    name: user_id,
                    displayName: "Test"
                },
                pubKeyCredParams: [
                    {alg: -7, type: "public-key"},
                ],
                authenticatorSelection: {
                    authenticatorAttachment: "platform"
                },
                extensions: {
                    prf: {
                        eval: {
                            first: firstSalt,
                        }
                    }
                }
            };
            
            try
            {
                
                var credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });
                var pk = Buffer.from(credential.rawId).toString('hex');

                alert('PublicKey: ' + pk);
                console.log('credential', credential);

                var exres = credential.getClientExtensionResults();
                console.log('exres', exres);

                if
                (
                    typeof exres == 'object' 
                    && typeof exres.prf == 'object'
                )
                {
                    alert('PRF: ' + JSON.stringify(exres.prf));
                }
            }
            catch(e)
            {
                alert(e);
            }
        });
    });
        
    get_buttons.forEach(function(button, i)
    {
        button.addEventListener("click", async function(e)
        {
            e.preventDefault();
            
            var publicKeyCredentialCreationOptions = 
            {
                challenge: Buffer.from('the-challenge', 'utf8'),
                rpId: domainId,
                user: {
                    id: Buffer.from(user_id, 'utf8'),
                    name: user_id,
                    displayName: "Test"
                },
                userVerification: "required",
                extensions: {
                    prf: {}
                }
            };
            
            try
            {
                
                var credential = await navigator.credentials.get({
                    publicKey: publicKeyCredentialCreationOptions
                });
                var pk = Buffer.from(credential.rawId).toString('hex');

                alert('PublicKey: ' + pk);
                console.log('credential', credential);

                var exres = credential.getClientExtensionResults();
                console.log('exres', exres);

                if
                (
                    typeof exres == 'object' 
                    && typeof exres.prf == 'object'
                )
                {
                    alert('PRF: ' + JSON.stringify(exres.prf));
                }
            }
            catch(e)
            {
                alert(e);
            }
        });
    });
    
    </script>
    
</html>