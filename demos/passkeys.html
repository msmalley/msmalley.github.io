<!DOCTYPE html>
<html>
    
    <head>
        
        <!-- META -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
        <link rel='dns-prefetch' href='//s.w.org' />
        <title>CORTEX JS</title>
        
        <!-- STYLES -->
        <link rel="stylesheet" href="css/mvp.css">
        <link rel="stylesheet" href="css/cortex.css">
        
    </head>
    <body data-mustache="cortex.config.sdk" data-loading="true" data-position="fixed" id="cortex-clipboard">
        
        <a href="#" class="create_passkey">CREATE v0.0.3</a> 
        <hr>
        <a href="#" onclick="get_passkey()">GET</a> 
        
    </body>
    
    <script src="../js/buffer.js"></script>
    <script src="../js/webauth.js"></script>
    
    <script>
    var domainId = 'smalley.my';
        
    var create_buttons = document.querySelectorAll('.create_passkey');

    create_buttons.forEach(function(button, i)
    {
        button.addEventListener("click", async function(e)
        {
            e.preventDefault();
            alert('clicked');
            
            var publicKeyCredentialCreationOptions = 
            {
                challenge: Buffer.from('the-challenge', 'utf8'),
                rp: {
                    name: "Example",
                    id: domainId
                },
                user: {
                    id: Buffer.from('the-user', 'utf8'),
                    name: "john78",
                    displayName: "John"
                },
                pubKeyCredParams: [
                    {alg: -7, type: "public-key"},
                ],
                authenticatorSelection: {
                    authenticatorAttachment: "platform",
                    requireResidentKey: true,
                    residentKey: "required"
                }
            };
            
            alert(JSON.stringify(publicKeyCredentialCreationOptions));
            alert(navigator);
            alert(JSON.stringify(navigator.credentials));
            alert(navigator.credentials.create);
            
            try
            {
                var credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                pk = Buffer.from(credential.rawId).toString('hex');

                alert('PublicKey: ' + pk);

                var exres = credential.getClientExtensionResults();

                if
                (
                    typeof exres == 'object' 
                    && typeof exres.prf == 'object'
                    && typeof exres.prf.enabled != 'undefined'
                )
                {
                    alert('PRF: ' + exres.prf.enabled);
                }
            }
            catch(e)
            {
                alert(e);
            }
        });
    });
    
    </script>
    
</html>